@Thetvdb =

  ENDPOINT: 'http://thetvdb.com/api'

  APIK_KEY: '<%= ENV['THETVDB_API_KEY'] %>'

  search: (showName) ->
    Request.get("#{@ENDPOINT}/GetSeries.php", seriesname: showName).then (response) ->
      shows = $('Series', response).get().map(SeriesToShow)

  getShow: (series_id) ->
    Request.get("#{@ENDPOINT}/#{@APIK_KEY}/series/#{series_id}/all").then (response) ->
      show = SeriesToShow($('Series', response).first())
      show.episodes = extractEpisodes(response, show)
      show

SeriesToShow = (series) ->
  series = $(series)
  get = (key) -> series.find(key).text()
  show = {}
  show.id             = get('seriesid')
  show.thetvdb_id     = get('seriesid')
  show.name           = get('SeriesName')
  show.aliases        = get('AliasNames').split('|')
  show.first_aired_at = get('FirstAired')
  show.imdb_id        = get('IMDB_ID')
  show.description    = get('Overview')
  show

extractEpisodes = (response, show) ->
  episodes = $(response).find('Episode')
  episodes.get().map (node) ->
    node = $(node)
    get = (key) -> node.find(key).text()
    episode = {}
    episode.show = show
    episode.thetvdb_id              = get('id')
    episode.thetvdb_series_id       = get('seriesid')
    episode.thetvdb_season_id       = get('seriesid')
    episode.name                    = get('EpisodeName')
    episode.description             = get('Overview')
    episode.first_aired_at          = get('FirstAired')
    episode.language                = get('Language')
    episode.language                = get('Language')
    episode.episode_number          = parseInt(get('Combined_episodenumber'), 10)
    episode.season_number           = parseInt(get('SeasonNumber'), 10)
    episode.seasonal_episode_number = parseInt(get('EpisodeNumber'), 10)
    episode



# http://thetvdb.com/api/GetSeries.php?seriesname=The+Daily+Show

# Get recently changes serieses?
# http://thetvdb.com/api/Updates.php?type=all&time=1437534456


# # search for series
# http://thetvdb.com/api/GetSeries.php?seriesname=Last+Man+ON+Earth


# # get series
# http://thetvdb.com/api/9D971F89A53A01B9/series/281622

# # get series with episodes
# http://thetvdb.com/api/9D971F89A53A01B9/series/281622/all
