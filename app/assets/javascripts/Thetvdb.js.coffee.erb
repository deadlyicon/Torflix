@Thetvdb =

  ENDPOINT: 'http://thetvdb.com/api'

  APIK_KEY: '<%= ENV['THETVDB_API_KEY'] %>'

  search: (showName) ->
    Request.get("#{@ENDPOINT}/GetSeries.php", seriesname: showName).then (response) ->
      series_id = $('Series id', response).text()
      Thetvdb.getShow(series_id)

  getShow: (series_id) ->
    Request.get("#{@ENDPOINT}/#{@APIK_KEY}/series/#{series_id}/all").then (response) ->
      show = extractshow(response)
      show.episodes = extractEpisodes(response)
      show

extractshow = (response) ->
  node = $(response).find('Series')
  get = (key) -> node.find(key).text()
  show = {}
  show.thetvdb_id     = get('seriesid')
  show.name           = get('SeriesName')
  show.aliases        = get('AliasNames').split('|')
  show.first_aired_at = get('FirstAired')
  show.imdb_id        = get('IMDB_ID')
  show.description    = get('Overview')
  show

extractEpisodes = (response) ->
  episodes = $(response).find('Episode')
  episodes.map ->
    node = $(this)
    get = (key) -> node.find(key).text()
    episode = {}
    episode.thetvdb_id              = get('id')
    episode.thetvdb_series_id       = get('seriesid')
    episode.thetvdb_season_id       = get('seriesid')
    episode.name                    = get('EpisodeName')
    episode.description             = get('Overview')
    episode.first_aired_at          = get('FirstAired')
    episode.language                = get('Language')
    episode.language                = get('Language')
    episode.episode_number          = get('Combined_episodenumber')
    episode.season_number           = get('SeasonNumber')
    episode.seasonal_episode_number = get('EpisodeNumber')
    episode



# http://thetvdb.com/api/GetSeries.php?seriesname=The+Daily+Show

# Get recently changes serieses?
# http://thetvdb.com/api/Updates.php?type=all&time=1437534456


# # search for series
# http://thetvdb.com/api/GetSeries.php?seriesname=Last+Man+ON+Earth


# # get series
# http://thetvdb.com/api/9D971F89A53A01B9/series/281622

# # get series with episodes
# http://thetvdb.com/api/9D971F89A53A01B9/series/281622/all
